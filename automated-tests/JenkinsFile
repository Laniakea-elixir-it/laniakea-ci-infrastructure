pipeline {
	agent { label "build-usegalaxy-it.wn1" }
		options { disableConcurrentBuilds() }
	stages {
		stage('deploy') {
			steps {
				withCredentials([string(credentialsId: 'iam-recas-laniakea-bot-password', variable: 'IAM_CLIENT_PASSWORD')]) {
					sh '''
					python3 -m venv tests/
					. tests/bin/activate
					pip install -r ./automated-tests/requirements.txt
					wget https://github.com/mozilla/geckodriver/releases/download/v0.26.0/geckodriver-v0.26.0-linux64.tar.gz
					tar -xf geckodriver-v0.26.0-linux64.tar.gz
					eval `oidc-keychain`
         	 		./automated-tests/expect.sh $IAM_CLIENT_PASSWORD
					git clone https://github.com/Laniakea-elixir-it/bioblend_test.git automated-tests/bioblend_test
          			./automated-tests/control-script.sh "dev"
					'''
				}
			}
		}
	}
	post { 
		always { 
			cleanWs()
		}
		success {
			echo 'SUCCESS!'
		}
		failure {
			mail bcc: '', body: 'Automated test for Laniakea Errored. Please check.', from: '', replyTo: '', subject: '[build-usegalaxy-it] Laniakea automated test - FAIL', to: 'ma.tangaro@ibiom.cnr.it'
		}
	}
}

